<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB SEHS Predictor | Antigravity</title>

    <!-- 1. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- 2. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3. React & ReactDOM (Core Logic) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- 4. Babel (Enables React code in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Configuration (API URLs) -->
    <script src="config.js"></script>

    <!-- 6. IB SEHS Theme Styles -->
    <style>
        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        @keyframes float {
            0% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(2deg);
            }

            100% {
                transform: translateY(0px) rotate(0deg);
            }
        }

        @keyframes drift {
            0% {
                transform: translateX(0px);
                opacity: 0.15;
            }

            50% {
                transform: translateX(30px);
                opacity: 0.3;
            }

            100% {
                transform: translateX(0px);
                opacity: 0.15;
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-drift {
            animation: drift 10s ease-in-out infinite;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 69, 135, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .glass-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            background: #ffffff;
            border-color: #fbba07;
            box-shadow: 0 8px 16px rgba(251, 186, 7, 0.3);
        }

        /* Custom Scrollbar */
        textarea::-webkit-scrollbar {
            width: 8px;
        }

        textarea::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        textarea::-webkit-scrollbar-thumb {
            background: #004587;
            border-radius: 4px;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            background: #fbba07;
        }
    </style>
</head>

<body style="background: linear-gradient(135deg, #004587 0%, #002a52 100%); color: #333; min-height: 100vh;">

    <!-- React App Mount Point -->
    <div id="root"></div>

    <!-- 5. Application Logic -->
    <script type="text/babel">
        const { useState } = React;

        // --- ICON COMPONENTS (SVG) ---
        // Simplified icons embedded directly to avoid external dependencies
        const Icons = {
            BarChart2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            Mail: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>,
            CheckSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        };

        // --- DATA ---
        const SEHS_DATA = [
            // Theme A: Physiology & Nutrition
            { code: 'A.1.1', title: 'Inter-system communication', hours: { sl: 10, hl: 0 }, marks: { sl: { p1a: 2, p2: 4 }, hl: { p1a: 2, p2: 4 } } },
            { code: 'A.1.2', title: 'Maintaining homeostasis', hours: { sl: 6, hl: 5 }, marks: { sl: { p1a: 1, p2: 3 }, hl: { p1a: 1, p2: 3 } } },
            { code: 'A.1.3', title: 'Transport', hours: { sl: 7, hl: 0 }, marks: { sl: { p1a: 2, p2: 3 }, hl: { p1a: 2, p2: 3 } } },
            { code: 'A.2.1', title: 'Water and electrolyte balance', hours: { sl: 3, hl: 0 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 1, p2: 1 } } },
            { code: 'A.2.2', title: 'Fuelling for health/performance', hours: { sl: 6, hl: 4 }, marks: { sl: { p1a: 2, p2: 3 }, hl: { p1a: 2, p2: 5 } } },
            { code: 'A.2.3', title: 'Energy systems', hours: { sl: 7, hl: 2 }, marks: { sl: { p1a: 2, p2: 3 }, hl: { p1a: 2, p2: 4 } } },
            { code: 'A.3.1', title: 'Qualities of training', hours: { sl: 6, hl: 0 }, marks: { sl: { p1a: 2, p2: 3 }, hl: { p1a: 1, p2: 3 } } },
            { code: 'A.3.2', title: 'Health benefits of activity', hours: { sl: 2, hl: 2 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 0, p2: 3 } } },
            { code: 'A.3.3', title: 'Fatigue and recovery', hours: { sl: 0, hl: 9 }, marks: { sl: { p1a: 0, p2: 0 }, hl: { p1a: 2, p2: 5 } } },

            // Theme B: Biomechanics
            { code: 'B.1.1', title: 'Anatomical position and movement', hours: { sl: 3, hl: 3 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 2, p2: 2 } } },
            { code: 'B.1.2', title: 'Connective tissues and joints', hours: { sl: 3, hl: 0 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 1, p2: 1 } } },
            { code: 'B.1.3', title: 'Muscular function', hours: { sl: 4, hl: 2 }, marks: { sl: { p1a: 1, p2: 2 }, hl: { p1a: 2, p2: 2 } } },
            { code: 'B.1.4', title: 'Levers in movement', hours: { sl: 2, hl: 0 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 1, p2: 1 } } },
            { code: 'B.2.1', title: 'Newton\u2019s laws of motion', hours: { sl: 5, hl: 12 }, marks: { sl: { p1a: 1, p2: 3 }, hl: { p1a: 4, p2: 9 } } },
            { code: 'B.2.2', title: 'Fluid mechanics', hours: { sl: 3, hl: 8 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 3, p2: 5 } } },
            { code: 'B.2.3', title: 'Movement analysis', hours: { sl: 3, hl: 0 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 1, p2: 1 } } },
            { code: 'B.3', title: 'Injury causes and prevention', hours: { sl: 7, hl: 2 }, marks: { sl: { p1a: 1, p2: 3 }, hl: { p1a: 2, p2: 4 } } },

            // Theme C: Sports Psychology
            { code: 'C.1', title: 'Individual differences', hours: { sl: 4, hl: 6 }, marks: { sl: { p1a: 1, p2: 2 }, hl: { p1a: 2, p2: 5 } } },
            { code: 'C.2.1', title: 'Motor learning processes', hours: { sl: 10, hl: 0 }, marks: { sl: { p1a: 2, p2: 5 }, hl: { p1a: 2, p2: 4 } } },
            { code: 'C.2.2', title: 'Attentional control', hours: { sl: 2, hl: 0 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 1, p2: 1 } } },
            { code: 'C.3', title: 'Motivation', hours: { sl: 8, hl: 8 }, marks: { sl: { p1a: 2, p2: 4 }, hl: { p1a: 3, p2: 7 } } },
            { code: 'C.4.1', title: 'Arousal and anxiety', hours: { sl: 3, hl: 0 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 1, p2: 1 } } },
            { code: 'C.4.2', title: 'Coping', hours: { sl: 2, hl: 2 }, marks: { sl: { p1a: 1, p2: 1 }, hl: { p1a: 0, p2: 2 } } },
            { code: 'C.5', title: 'Psychological skills', hours: { sl: 4, hl: 5 }, marks: { sl: { p1a: 1, p2: 2 }, hl: { p1a: 2, p2: 4 } } }
        ];

        // --- COMPONENTS ---

        const PaperBlock = ({ title, level, paper, data, onChange, themeColor, maxPoints }) => {
            const getVal = (field) => data?.[level]?.[paper]?.[field] || '';

            const borderFocus = 'focus:border-[#fbba07] focus:shadow-[0_0_10px_rgba(251,186,7,0.2)]';
            const textTheme = 'text-[#004587]';
            const tildeColor = 'text-[#fbba07]';

            return (
                <div className="bg-white rounded-md p-3 border border-[#e0e0e0] mb-3 last:mb-0 hover:border-[#fbba07] transition-colors group shadow-sm">
                    <h4 className={`text-xs font-mono font-bold uppercase tracking-wider mb-3 ${textTheme} flex items-center gap-2 border-b border-[#e0e0e0] pb-2 group-hover:border-[#fbba07] transition-colors`}>
                        <Icons.FileText /> {title}
                    </h4>

                    <div className="space-y-3">
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <label className="flex items-center gap-2 text-[10px] uppercase text-[#666] font-semibold">
                                    <span className={`text-lg font-serif ${tildeColor} leading-none`}>~</span>
                                    Predicted Points
                                </label>
                                <span className="text-[10px] font-mono text-gray-400">Suggested: {maxPoints}</span>
                            </div>
                            <input
                                type="number"
                                min="0"
                                className={`w-full bg-white border border-[#e0e0e0] rounded px-2 py-1.5 text-[#333] text-sm ${borderFocus} focus:outline-none transition-all duration-300 font-mono`}
                                placeholder={`0-${maxPoints}`}
                                value={getVal('points')}
                                onChange={(e) => {
                                    const inputValue = e.target.value;
                                    if (inputValue === '') {
                                        onChange(level, paper, 'points', '');
                                        return;
                                    }
                                    let val = parseInt(inputValue);
                                    if (isNaN(val)) return; // Ignore invalid inputs
                                    if (val < 0) val = 0;
                                    onChange(level, paper, 'points', val.toString())
                                }}
                            />
                        </div>

                        <div>
                            <label className="block text-[10px] uppercase text-[#666] mb-1">Draft Question(s)</label>
                            <textarea
                                className={`w-full bg-white border border-[#e0e0e0] rounded px-2 py-1.5 text-[#333] text-sm h-24 ${borderFocus} focus:outline-none transition-all duration-300 resize-none font-sans`}
                                placeholder="Type your question..."
                                value={getVal('question')}
                                onChange={(e) => onChange(level, paper, 'question', e.target.value)}
                            />
                        </div>

                        <div>
                            <label className="block text-[10px] uppercase text-[#666] mb-1">Mark Scheme</label>
                            <textarea
                                className={`w-full bg-white border border-[#e0e0e0] rounded px-2 py-1.5 text-[#333] text-sm h-24 ${borderFocus} focus:outline-none transition-all duration-300 resize-none font-sans`}
                                placeholder="Key marking points..."
                                value={getVal('markscheme')}
                                onChange={(e) => onChange(level, paper, 'markscheme', e.target.value)}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        const UnitRow = ({ unit, data, onChange, isExpanded, onToggle }) => {
            // Calculate progress for this unit (separate SL and HL)
            const slPredicted = (parseInt(data?.sl?.p1a?.points) || 0) + (parseInt(data?.sl?.p2?.points) || 0);
            const slMax = unit.marks.sl.p1a + unit.marks.sl.p2;
            const slPct = slMax > 0 ? Math.round((slPredicted / slMax) * 100) : 0;

            const hlPredicted = (parseInt(data?.hl?.p1a?.points) || 0) + (parseInt(data?.hl?.p2?.points) || 0);
            const hlMax = unit.marks.hl.p1a + unit.marks.hl.p2;
            const hlPct = hlMax > 0 ? Math.round((hlPredicted / hlMax) * 100) : 0;

            const hasAnyInput = slPredicted > 0 || hlPredicted > 0;

            return (
                <div className={`mb-4 border rounded-lg overflow-hidden transition-all duration-300 ${isExpanded ? 'border-[#fbba07] bg-white shadow-lg' : 'border-[#e0e0e0] bg-white hover:border-[#fbba07]'}`}>
                    <div
                        className="flex items-center justify-between p-4 cursor-pointer hover:bg-[#f8f9fa] transition-colors"
                        onClick={onToggle}
                    >
                        <div className="flex items-center gap-4 flex-1">
                            <div className="flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${hasAnyInput ? 'bg-[#22c55e]' : isExpanded ? 'bg-[#fbba07] animate-pulse' : 'bg-[#e0e0e0]'}`}></div>
                                <div className="w-16 font-mono font-bold text-[#004587]">{unit.code}</div>
                            </div>
                            <div className="flex-1">
                                <div className="font-medium text-[#333]">{unit.title}</div>
                                {/* SL Progress Bar */}
                                <div className="flex items-center gap-2 mt-1.5">
                                    <span className="text-[9px] font-bold text-[#004587] w-5">SL</span>
                                    <div className="flex-1 bg-gray-200 rounded-full h-1.5 overflow-hidden max-w-[160px]">
                                        <div className="h-full rounded-full transition-all duration-500 ease-out" style={{
                                            width: `${slPct}%`,
                                            background: slPct === 100
                                                ? 'linear-gradient(90deg, #22c55e 0%, #16a34a 100%)'
                                                : slPct > 0
                                                    ? 'linear-gradient(90deg, #004587 0%, #0066cc 100%)'
                                                    : 'transparent'
                                        }}></div>
                                    </div>
                                    <span className="text-[10px] font-mono text-gray-400 whitespace-nowrap">{slPredicted}/{slMax}</span>
                                </div>
                                {/* HL Progress Bar */}
                                <div className="flex items-center gap-2 mt-0.5">
                                    <span className="text-[9px] font-bold w-5" style={{ color: '#e0a800' }}>HL</span>
                                    <div className="flex-1 bg-gray-200 rounded-full h-1.5 overflow-hidden max-w-[160px]">
                                        <div className="h-full rounded-full transition-all duration-500 ease-out" style={{
                                            width: `${hlPct}%`,
                                            background: hlPct === 100
                                                ? 'linear-gradient(90deg, #22c55e 0%, #16a34a 100%)'
                                                : hlPct > 0
                                                    ? 'linear-gradient(90deg, #fbba07 0%, #ffcc33 100%)'
                                                    : 'transparent'
                                        }}></div>
                                    </div>
                                    <span className="text-[10px] font-mono text-gray-400 whitespace-nowrap">{hlPredicted}/{hlMax}</span>
                                </div>
                            </div>

                            <div className="flex gap-2 text-xs mr-4 items-center hidden sm:flex">
                                <div className="grid grid-cols-2 gap-2">
                                    {/* SL Section */}
                                    <div className="flex flex-col items-center px-2 py-1 bg-[#e6f3ff] rounded border border-[#004587]" style={{ borderWidth: '2px' }}>
                                        <span className="text-[9px] text-[#004587] font-bold uppercase mb-0.5">SL Hours: {unit.hours?.sl || 0}</span>
                                        <span className="text-[#004587] font-bold font-mono text-sm">
                                            Marks: {unit.marks.sl.p1a + unit.marks.sl.p2}
                                            <span className="text-[8px] font-normal ml-1 text-gray-500 block">
                                                (P1:{unit.marks.sl.p1a}, P2:{unit.marks.sl.p2})
                                            </span>
                                        </span>
                                    </div>

                                    {/* HL Section */}
                                    <div className="flex flex-col items-center px-2 py-1 bg-[#fff9e6] rounded border border-[#fbba07]" style={{ borderWidth: '2px' }}>
                                        <span className="text-[9px] font-bold uppercase mb-0.5" style={{ color: '#e0a800' }}>HL Hours: {unit.hours?.hl || 0}</span>
                                        <span className="font-bold font-mono text-sm" style={{ color: '#e0a800' }}>
                                            Marks: {unit.marks.hl.p1a + unit.marks.hl.p2}
                                            <span className="text-[8px] font-normal ml-1 text-gray-500 block">
                                                (P1:{unit.marks.hl.p1a}, P2:{unit.marks.hl.p2})
                                            </span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {isExpanded ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                    </div>

                    {isExpanded && (
                        <div className="p-4 bg-[#f8f9fa] border-t border-[#e0e0e0] grid grid-cols-1 lg:grid-cols-2 gap-6 relative">
                            <div className="absolute left-1/2 top-0 bottom-0 w-px bg-[#e0e0e0] hidden lg:block"></div>

                            {/* SL Column */}
                            <div className="glass-card p-4 rounded-lg relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-[#004587]" style={{ opacity: 0.5 }}></div>
                                <div className="flex items-center justify-between mb-4 border-b border-[#e0e0e0] pb-2">
                                    <h3 className="font-bold text-[#004587] flex items-center gap-2 font-mono">
                                        Standard Level (SL)
                                    </h3>
                                </div>

                                <PaperBlock title="Paper 1A" level="sl" paper="p1a" data={data} onChange={(l, p, f, v) => onChange(unit.code, l, p, f, v)} themeColor="blue" maxPoints={unit.marks.sl.p1a} />
                                <PaperBlock title="Paper 2" level="sl" paper="p2" data={data} onChange={(l, p, f, v) => onChange(unit.code, l, p, f, v)} themeColor="blue" maxPoints={unit.marks.sl.p2} />
                            </div>

                            {/* HL Column */}
                            <div className="glass-card p-4 rounded-lg relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-[#fbba07]" style={{ opacity: 0.7 }}></div>
                                <div className="flex items-center justify-between mb-4 border-b border-[#e0e0e0] pb-2">
                                    <h3 className="font-bold text-[#004587] flex items-center gap-2 font-mono">
                                        Higher Level (HL)
                                    </h3>
                                </div>

                                <PaperBlock title="Paper 1A" level="hl" paper="p1a" data={data} onChange={(l, p, f, v) => onChange(unit.code, l, p, f, v)} themeColor="gold" maxPoints={unit.marks.hl.p1a} />
                                <PaperBlock title="Paper 2" level="hl" paper="p2" data={data} onChange={(l, p, f, v) => onChange(unit.code, l, p, f, v)} themeColor="gold" maxPoints={unit.marks.hl.p2} />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const { useState, useEffect } = React;
            const [userInfo, setUserInfo] = useState({ email: '', username: '' });
            const [formData, setFormData] = useState({});
            const [expandedRow, setExpandedRow] = useState(null);
            const [saveStatus, setSaveStatus] = useState(''); // 'saving', 'saved', 'error'
            const [isLoading, setIsLoading] = useState(false);

            // Auto-save functionality
            useEffect(() => {
                if (!userInfo.email || !userInfo.username) return;

                const autoSaveInterval = setInterval(() => {
                    if (Object.keys(formData).length > 0) {
                        handleSave(true); // true = auto-save, don't show alerts
                    }
                }, CONFIG.AUTO_SAVE_INTERVAL); // 2 minutes

                return () => clearInterval(autoSaveInterval);
            }, [formData, userInfo]);

            // Load existing predictions when email is entered
            const loadExistingPredictions = async (email) => {
                if (!email || email.length < 5) return;

                setIsLoading(true);
                try {
                    const response = await fetch(`${CONFIG.API_URL}?action=get-my-predictions&email=${encodeURIComponent(email)}`);
                    const result = await response.json();

                    if (result.success && result.predictions.length > 0) {
                        // Restore username if available
                        if (result.predictions[0].username) {
                            setUserInfo(prev => ({ ...prev, username: result.predictions[0].username }));
                        }

                        // Convert array of predictions back to formData structure
                        const loadedData = {};
                        result.predictions.forEach(pred => {
                            if (!loadedData[pred.unitCode]) loadedData[pred.unitCode] = {};
                            if (!loadedData[pred.unitCode][pred.level]) loadedData[pred.unitCode][pred.level] = {};
                            loadedData[pred.unitCode][pred.level][pred.paper] = {
                                points: pred.predictedPoints,
                                question: pred.question,
                                markscheme: pred.markScheme
                            };
                        });
                        setFormData(loadedData);
                        setSaveStatus('loaded');
                        setTimeout(() => setSaveStatus(''), 2000);
                    }
                } catch (error) {
                    console.error('Error loading predictions:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            // Save predictions to backend
            const handleSave = async (isAutoSave = false) => {
                if (!userInfo.email || !userInfo.username) {
                    if (!isAutoSave) alert('Please enter your email and username first!');
                    return;
                }

                if (!isAutoSave) setSaveStatus('saving');

                try {
                    // Convert formData to array of predictions for backend
                    const predictions = [];
                    Object.entries(formData).forEach(([unitCode, levels]) => {
                        Object.entries(levels).forEach(([level, papers]) => {
                            Object.entries(papers).forEach(([paper, data]) => {
                                if (data.points || data.question || data.markscheme) {
                                    predictions.push({
                                        action: 'submit',
                                        email: userInfo.email,
                                        username: userInfo.username,
                                        unitCode,
                                        level,
                                        paper,
                                        predictedPoints: data.points || '',
                                        question: data.question || '',
                                        markScheme: data.markscheme || '',
                                        status: 'draft'
                                    });
                                }
                            });
                        });
                    });

                    // Save each prediction using GET to avoid CORS preflight
                    for (const prediction of predictions) {
                        const params = new URLSearchParams(prediction);
                        await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    }

                    if (!isAutoSave) {
                        setSaveStatus('saved');
                        setTimeout(() => setSaveStatus(''), 2000);
                    }
                } catch (error) {
                    console.error('Error saving:', error);
                    if (!isAutoSave) {
                        setSaveStatus('error');
                        setTimeout(() => setSaveStatus(''), 3000);
                    }
                }
            };

            const handleUserChange = (field, value) => {
                setUserInfo(prev => ({ ...prev, [field]: value }));

                // Load existing predictions when email is entered/changed
                if (field === 'email' && value.includes('@')) {
                    loadExistingPredictions(value);
                }
            };

            const handleUnitChange = (unitCode, level, paper, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [unitCode]: {
                        ...prev[unitCode],
                        [level]: {
                            ...prev[unitCode]?.[level],
                            [paper]: {
                                ...prev[unitCode]?.[level]?.[paper],
                                [field]: value
                            }
                        }
                    }
                }));
            };

            const toggleRow = (code) => {
                setExpandedRow(prev => prev === code ? null : code);
            };

            const handleExport = () => {
                handleSave(); // Save to Google Sheets backend
            };

            const calculateTotalPredicted = () => {
                let slTotal = 0;
                let hlTotal = 0;

                Object.values(formData).forEach(unit => {
                    if (unit.sl) {
                        if (unit.sl.p1a?.points) slTotal += (parseInt(unit.sl.p1a.points) || 0);
                        if (unit.sl.p2?.points) slTotal += (parseInt(unit.sl.p2.points) || 0);
                    }
                    if (unit.hl) {
                        if (unit.hl.p1a?.points) hlTotal += (parseInt(unit.hl.p1a.points) || 0);
                        if (unit.hl.p2?.points) hlTotal += (parseInt(unit.hl.p2.points) || 0);
                    }
                });
                return { slTotal, hlTotal };
            };

            const calculateProgress = () => {
                let slP1aTotal = 0, slP1aMax = 0;
                let slP2Total = 0, slP2Max = 0;
                let hlP1aTotal = 0, hlP1aMax = 0;
                let hlP2Total = 0, hlP2Max = 0;

                SEHS_DATA.forEach(unit => {
                    // Max points
                    slP1aMax += unit.marks.sl.p1a;
                    slP2Max += unit.marks.sl.p2;
                    hlP1aMax += unit.marks.hl.p1a;
                    hlP2Max += unit.marks.hl.p2;

                    // User points calculation needs to be safe
                    const unitData = formData[unit.code];
                    if (unitData) {
                        if (unitData.sl?.p1a?.points) slP1aTotal += (parseInt(unitData.sl.p1a.points) || 0);
                        if (unitData.sl?.p2?.points) slP2Total += (parseInt(unitData.sl.p2.points) || 0);
                        if (unitData.hl?.p1a?.points) hlP1aTotal += (parseInt(unitData.hl.p1a.points) || 0);
                        if (unitData.hl?.p2?.points) hlP2Total += (parseInt(unitData.hl.p2.points) || 0);
                    }
                });

                return {
                    slP1a: { current: slP1aTotal, max: slP1aMax },
                    slP2: { current: slP2Total, max: slP2Max },
                    hlP1a: { current: hlP1aTotal, max: hlP1aMax },
                    hlP2: { current: hlP2Total, max: hlP2Max }
                };
            };

            const stats = calculateTotalPredicted();
            const progress = calculateProgress();

            return (
                <div className="relative min-h-screen font-sans">

                    {/* Background Animation */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden z-0">
                        <div className="absolute top-20 left-10 w-64 h-64 rounded-full blur-[80px] animate-float" style={{ background: 'rgba(251, 186, 7, 0.1)' }}></div>
                        <div className="absolute bottom-20 right-10 w-96 h-96 rounded-full blur-[100px] animate-drift" style={{ background: 'rgba(0, 69, 135, 0.1)' }}></div>
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] rounded-full blur-[120px]" style={{ background: 'rgba(251, 186, 7, 0.05)' }}></div>

                        {/* Particles */}
                        <div className="absolute top-1/4 left-1/4 w-2 h-2 rounded-full animate-float" style={{ background: 'rgba(251, 186, 7, 0.2)' }}></div>
                        <div className="absolute top-3/4 left-1/3 w-1 h-1 rounded-full animate-float" style={{ background: 'rgba(251, 186, 7, 0.3)', animationDelay: '1s' }}></div>
                        <div className="absolute top-1/2 right-1/4 w-3 h-3 rounded-full animate-float" style={{ background: 'rgba(0, 69, 135, 0.2)', animationDelay: '2s' }}></div>
                    </div>

                    {/* Navbar */}
                    <div className="glass-panel sticky top-0 z-50 border-b-3" style={{ borderBottom: '3px solid #fbba07' }}>
                        <div className="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2 rounded-lg border" style={{ background: 'rgba(251, 186, 7, 0.1)', borderColor: '#fbba07' }}>
                                    <Icons.BarChart2 />
                                </div>
                                <div>
                                    <h1 className="font-bold text-xl leading-none tracking-tight" style={{ color: '#004587' }}>IB SEHS <span style={{ color: '#fbba07' }}>Predictor</span></h1>
                                    <span className="text-xs font-mono" style={{ color: '#666' }}>Exam Strategy Database</span>
                                </div>
                            </div>

                            {/* Save Status Indicator */}
                            <div className="flex items-center gap-4">
                                {saveStatus && (
                                    <span className={`text-xs font-mono px-3 py-1 rounded ${saveStatus === 'saving' ? 'bg-blue-100 text-blue-700' :
                                        saveStatus === 'saved' ? 'bg-green-100 text-green-700' :
                                            saveStatus === 'loaded' ? 'bg-purple-100 text-purple-700' :
                                                'bg-red-100 text-red-700'
                                        }`}>
                                        {saveStatus === 'saving' ? 'üíæ Saving...' :
                                            saveStatus === 'saved' ? '‚úì Saved' :
                                                saveStatus === 'loaded' ? '‚úì Loaded' :
                                                    '‚ö† Error'}
                                    </span>
                                )}
                                <a href="landing.html" className="text-sm font-mono hover:underline" style={{ color: '#666' }}>‚Üê Back to Home</a>
                                <button
                                    onClick={handleExport}
                                    className="flex items-center gap-2 text-white px-4 py-2 rounded-md transition-all font-medium text-sm"
                                    style={{ background: 'linear-gradient(135deg, #fbba07 0%, #e0a800 100%)', boxShadow: '0 4px 12px rgba(251, 186, 7, 0.3)' }}
                                    onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                    onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                >
                                    <Icons.Download />
                                    Save Progress
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="relative z-10 max-w-6xl mx-auto px-4 py-8">

                        {/* User Info Card */}
                        <div className="glass-panel rounded-xl p-6 mb-8 relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity" style={{ color: '#004587' }}>
                                <Icons.User />
                            </div>
                            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 font-mono" style={{ color: '#004587' }}>
                                <Icons.User /> Candidate Identity
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm mb-1 font-mono" style={{ color: '#666' }}>Email Address (Hidden)</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-2.5" style={{ color: '#666' }}><Icons.Mail /></div>
                                        <input
                                            type="email"
                                            className="w-full bg-white border border-[#e0e0e0] rounded-md py-2 pl-10 pr-4 focus:outline-none transition-colors"
                                            style={{ color: '#333' }}
                                            placeholder="student@school.edu"
                                            value={userInfo.email}
                                            onChange={(e) => handleUserChange('email', e.target.value)}
                                            onFocus={(e) => e.target.style.borderColor = '#fbba07'}
                                            onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                                        />
                                    </div>
                                    <p className="text-xs mt-1 flex items-center gap-1 font-mono" style={{ color: '#666' }}><Icons.CheckSquare /> Encrypted locally</p>
                                </div>
                                <div>
                                    <label className="block text-sm mb-1 font-mono" style={{ color: '#666' }}>Username (Free Choice)</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-2.5" style={{ color: '#666' }}><Icons.User /></div>
                                        <input
                                            type="text"
                                            className="w-full bg-white border border-[#e0e0e0] rounded-md py-2 pl-10 pr-4 focus:outline-none transition-colors"
                                            style={{ color: '#333' }}
                                            placeholder="Create a username..."
                                            value={userInfo.username}
                                            onChange={(e) => handleUserChange('username', e.target.value)}
                                            onFocus={(e) => e.target.style.borderColor = '#fbba07'}
                                            onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Stats Summary */}
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="glass-card p-4 rounded-lg relative overflow-hidden border-l-4" style={{ borderLeftColor: '#004587' }}>
                                <div className="z-10 relative">
                                    <span className="text-xs font-mono block mb-1 uppercase tracking-wider" style={{ color: '#666' }}>Total SL Predicted</span>
                                    <span className="text-3xl font-bold font-mono" style={{ color: '#004587' }}>{stats.slTotal}</span>
                                    <span className="text-xs ml-2" style={{ color: '#666' }}>(Paper 1A + Paper 2)</span>
                                </div>
                            </div>
                            <div className="glass-card p-4 rounded-lg relative overflow-hidden border-l-4" style={{ borderLeftColor: '#fbba07' }}>
                                <div className="z-10 relative">
                                    <span className="text-xs font-mono block mb-1 uppercase tracking-wider" style={{ color: '#666' }}>Total HL Predicted</span>
                                    <span className="text-3xl font-bold font-mono" style={{ color: '#fbba07' }}>{stats.hlTotal}</span>
                                    <span className="text-xs ml-2" style={{ color: '#666' }}>(Paper 1A + Paper 2)</span>
                                </div>
                            </div>
                        </div>

                        {/* Progress Tracker */}
                        <div className="glass-panel rounded-xl p-6 mb-6">
                            <h3 className="text-sm font-bold mb-4 uppercase tracking-wider" style={{ color: '#004587' }}>üìä Your Progress by Paper</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {/* SL P1A */}
                                <div className="flex flex-col">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs font-semibold" style={{ color: '#004587' }}>SL P1A</span>
                                        <span className="text-xs font-mono font-bold" style={{ color: '#004587' }}>{progress.slP1a.current}/{progress.slP1a.max}</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div className="h-full rounded-full transition-all duration-300" style={{
                                            width: `${progress.slP1a.max > 0 ? (progress.slP1a.current / progress.slP1a.max) * 100 : 0}%`,
                                            background: 'linear-gradient(90deg, #004587 0%, #0066cc 100%)'
                                        }}></div>
                                    </div>
                                    <span className="text-[10px] text-gray-500 mt-1">{progress.slP1a.max > 0 ? Math.round((progress.slP1a.current / progress.slP1a.max) * 100) : 0}% complete</span>
                                </div>

                                {/* SL P2 */}
                                <div className="flex flex-col">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs font-semibold" style={{ color: '#004587' }}>SL P2</span>
                                        <span className="text-xs font-mono font-bold" style={{ color: '#004587' }}>{progress.slP2.current}/{progress.slP2.max}</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div className="h-full rounded-full transition-all duration-300" style={{
                                            width: `${progress.slP2.max > 0 ? (progress.slP2.current / progress.slP2.max) * 100 : 0}%`,
                                            background: 'linear-gradient(90deg, #004587 0%, #0066cc 100%)'
                                        }}></div>
                                    </div>
                                    <span className="text-[10px] text-gray-500 mt-1">{progress.slP2.max > 0 ? Math.round((progress.slP2.current / progress.slP2.max) * 100) : 0}% complete</span>
                                </div>

                                {/* HL P1A */}
                                <div className="flex flex-col">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs font-semibold" style={{ color: '#fbba07' }}>HL P1A</span>
                                        <span className="text-xs font-mono font-bold" style={{ color: '#fbba07' }}>{progress.hlP1a.current}/{progress.hlP1a.max}</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div className="h-full rounded-full transition-all duration-300" style={{
                                            width: `${progress.hlP1a.max > 0 ? (progress.hlP1a.current / progress.hlP1a.max) * 100 : 0}%`,
                                            background: 'linear-gradient(90deg, #fbba07 0%, #ffcc33 100%)'
                                        }}></div>
                                    </div>
                                    <span className="text-[10px] text-gray-500 mt-1">{progress.hlP1a.max > 0 ? Math.round((progress.hlP1a.current / progress.hlP1a.max) * 100) : 0}% complete</span>
                                </div>

                                {/* HL P2 */}
                                <div className="flex flex-col">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs font-semibold" style={{ color: '#fbba07' }}>HL P2</span>
                                        <span className="text-xs font-mono font-bold" style={{ color: '#fbba07' }}>{progress.hlP2.current}/{progress.hlP2.max}</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div className="h-full rounded-full transition-all duration-300" style={{
                                            width: `${progress.hlP2.max > 0 ? (progress.hlP2.current / progress.hlP2.max) * 100 : 0}%`,
                                            background: 'linear-gradient(90deg, #fbba07 0%, #ffcc33 100%)'
                                        }}></div>
                                    </div>
                                    <span className="text-[10px] text-gray-500 mt-1">{progress.hlP2.max > 0 ? Math.round((progress.hlP2.current / progress.hlP2.max) * 100) : 0}% complete</span>
                                </div>
                            </div>
                        </div>

                        {/* Units List */}
                        <div className="space-y-1">
                            <div className="flex justify-between items-center mb-4 pb-2" style={{ borderBottom: '2px solid #fbba07' }}>
                                <h2 className="text-xl font-bold flex items-center gap-2" style={{ color: '#004587' }}>
                                    <Icons.BarChart2 /> Unit Database
                                </h2>
                                <button
                                    onClick={() => setExpandedRow(expandedRow === 'all' ? null : 'all')}
                                    className="text-sm hover:underline font-mono"
                                    style={{ color: '#fbba07' }}
                                >
                                    {expandedRow === 'all' ? 'Collapse All' : 'Expand All'}
                                </button>
                            </div>

                            {SEHS_DATA.map(unit => (
                                <UnitRow
                                    key={unit.code}
                                    unit={unit}
                                    data={formData[unit.code]}
                                    onChange={handleUnitChange}
                                    isExpanded={expandedRow === 'all' || expandedRow === unit.code}
                                    onToggle={() => toggleRow(unit.code)}
                                />
                            ))}
                        </div>

                        {/* Footer */}
                        <div className="mt-12 text-center text-xs font-mono pb-8 pt-8" style={{ borderTop: '1px solid rgba(255,255,255,0.2)', color: 'rgba(255,255,255,0.8)' }}>
                            <p>IB SEHS Exam Predictor ‚Ä¢ Antigravity Build v1.0</p>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>